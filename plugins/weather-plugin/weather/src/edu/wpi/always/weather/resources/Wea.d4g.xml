<?xml version="1.0" encoding="utf-8"?>
<model about="urn:disco.wpi.edu:models:Wea" xmlns="http://www.cs.wpi.edu/~rich/d4g"
	xmlns:t="http://www.cs.wpi.edu/~rich/cetask/cea-2018-ext">

	<t:script init="true">
		var $friend;
		function Person (name, data) { this.name = name; this.data = data; }
		
		Person.ENUM = {person0 : new Person("Ed",
                                            {locationName: "Florida",
                                            weatherCondition: "hot", 
                                            temperature: "90",
                                            humidity: "80 percent"})}
    
    	Person.prototype.toString = function () { return this.name; }	
	
	
	
		var $weatherJSON = {"currentWeather":{"locationName":"Worcester, MA","temperature":"67.1","weatherCondition":"Light Rain","humidity":"97%"},"radar":{"radarURL":"http://resize.wunderground.com/cgi-bin/resize_convert?ox\u003dgif\u0026url\u003dradblast/cgi-bin/radar/WUNIDS_composite%3Fcenterlat\u003d42.27581787%26centerlon\u003d-71.82014465%26radius\u003d75%26newmaps\u003d1%26smooth\u003d1%26reproj.automerc\u003d1%26api_key\u003dcd3b2dc51dd67e26"},"alert":{"alertMessage":"My Sample alert"},"almanac":{"recordLow":{"year":1934,"averageTemp":61,"extremeTemp":46},"recordHigh":{"year":1944,"averageTemp":78,"extremeTemp":96}},"forecast":[{"date":{"date":"08/16/12","daysApartFromToday":0},"summary":"Mostly cloudy with a chance of a thunderstorm and a chance of rain in the morning, then partly cloudy with a chance of a thunderstorm and a chance of rain. High of 81F. Winds from the NW at 5 to 10 mph. Chance of rain 30%."},{"date":{"date":"08/17/12","daysApartFromToday":1},"summary":"Partly cloudy. Fog overnight. Low of 63F. Winds from the West at 5 to 10 mph."},{"date":{"date":"08/18/12","daysApartFromToday":2},"summary":"Clear in the morning, then partly cloudy with a chance of a thunderstorm and a chance of rain. High of 84F. Winds from the WSW at 10 to 15 mph. Chance of rain 20%."}],"interestCities":{"Boston, MA":{"locationName":"Boston, MA","temperature":"70.4","weatherCondition":"Light Rain","humidity":"86%"},"Tampa, FL":{"locationName":"Tampa, FL","temperature":"80.2","weatherCondition":"Scattered Clouds","humidity":"80%"},"Memphis, TN":{"locationName":"Memphis, TN","temperature":"73","weatherCondition":"Partly Cloudy","humidity":"90%"}},"friends":{"Philip Morley":{"locationName":"Tampa, FL","temperature":"80.2","weatherCondition":"Scattered Clouds","humidity":"80%"},"Harriet Jones":{"locationName":"Boston, MA","temperature":"70.4","weatherCondition":"Light Rain","humidity":"86%"},"Marion Smith":{"locationName":"Dorchester, MA","temperature":"68.5","weatherCondition":"Light Rain","humidity":"92%"},"Diane Ferguson":{"locationName":"Boston, MA","temperature":"70.4","weatherCondition":"Light Rain","humidity":"86%"},"Linda Jefferson":{"locationName":"Memphis, TN","temperature":"73","weatherCondition":"Partly Cloudy","humidity":"90%"}}};
		function setWeatherData(weatherData){
			$weatherJSON = weatherData;
			
			Person.ENUM = {};
			for (var key in weatherData.friends) {
				var value = weatherData.friends[key];
				Person.ENUM[key] = new Person(key, value);
			}
		}

		//get time
		var period;
		if ( period == undefined ) { // for testing
			var dTime = new Date();
			var hours = dTime.getHours();
			period = "morning";
			if (hours > 12) period = "afternoon";
			if (hours > 17) period = "evening";
		}
		
	</t:script>

	<!-- Level 1 -->
	<t:task id="Weather">
		<t:subtasks id="WeatherSubtask">
			<t:step name="greeting" task="Greeting" />
			<t:step name="weatherChat" task="WeatherChat" />
			<t:step name="ending" task="Ending" />
		</t:subtasks>
	</t:task>

	<!-- Level 2: Greeting -->
	<agent id="Greeting" text="Sure!">
		<user text="Good Morning." applicable="period=='morning'">
			<agent text="Good morning!" />
		</user>

		<user text="Good Afternoon." applicable="period=='afternoon'">
			<agent text="Good afternoon!" />
		</user>

		<user text="Good Evening." applicable="period=='evening'">
			<agent text="Good evening!" />
		</user>

		<user text="Hiddddd">
			<agent text="HI there!" />
		</user>
	</agent>


	<!-- Level 2: WeatherChat -->
	<t:task id="WeatherChat">
		<t:subtasks id="StartWeatherChatSubtask">
			<t:step name="localalert" task="LocalAlert" minOccurs="0"/>
			<t:step name="localweather" task="LocalWeather" minOccurs="0"/>
			<t:step name="localweatherextended" task="LocalWeatherExtended" minOccurs="0"/>
			<t:step name="relationshipweather" task="RelationshipWeather" minOccurs="0" maxOccurs="5"></t:step>
			
			<!--
			<t:step name="globalweather" task="_GlobalWeather"></t:step>-->
		</t:subtasks>
	</t:task>
	
	<agent id="LocalAlert" text="{$weatherJSON.alert.alertMessage}" precondition="($weatherJSON.alert !== undefined)?null:false">
		<user text="Thanks for letting me know"/>
	</agent>

	<agent id="LocalWeather" text="so your location is {$weatherJSON.currentWeather.locationName}.  What do you want to know about weather?" precondition="($weatherJSON.currentWeather !== undefined)?null:false">
		<!-- Level 4: Different aspects of today's weather' -->
		<user text="What's the temperature?">
			<agent
				text="Right now, the temperature is {$weatherJSON.currentWeather.temperature} fahrenheit and it is {$weatherJSON.currentWeather.weatherCondition}">
				<agent ref="LocalWeather" />
			</agent>
		</user>


		<user text="How does it feel outside?">
			<agent
				text="With {$weatherJSON.currentWeather.humidity} humidity, it feels like {$weatherJSON.currentWeather.temperature} degrees fahrenheit.">
				<agent ref="LocalWeather" />
			</agent>
		</user>

		<!--<user text="Please show me the Radar image">
			<agent text="Here you go:  {$weatherJSON.radar.radarURL}">
				<agent ref="LocalWeather" />
			</agent>
		</user>-->
	</agent>
	
	
	
	
	
	<!-- Level 3: Local Weather extended -->
	<agent id="LocalWeatherExtended" text="The record high is {$weatherJSON.almanac.recordHigh.extremeTemp} degrees. It happened in {$weatherJSON.almanac.recordHigh.year}." precondition="($weatherJSON.almanac !== undefined)?null:false">
		<user text="Wow, go on.">
			<agent
				text="The record low is {$weatherJSON.almanac.recordLow.extremeTemp} degrees. It happened in  {$weatherJSON.almanac.recordLow.year}.">
				<user text="That's pretty cold.">
					<agent
						text="Yeah.  Compared to the average temperatures of {$weatherJSON.almanac.recordLow.averageTemp} and {$weatherJSON.almanac.recordHigh.averageTemp}, that's a big difference.">
						<user text="Indeed.  Thanks for telling me." />
						<user text="Sure glad I'm here" />
					</agent>
				</user>
			</agent>
		</user>
	</agent>
	
	<!-- Level 3: TalkFriends -->
	<t:task id="RelationshipWeather">
		<t:subtasks id="relationshipWeatherSubtasks">
                	<t:step name="pick" task="PickFriend"/>
					<t:step name="weather" task="_FriendWeather"/>
			</t:subtasks>
	</t:task>
	
	<t:task id="PickFriend">
		<t:input name="selectedPerson" type="Person"/>
		<t:binding slot="$this.external" value="false"/>
		<t:script>
			$friend = $this.selectedPerson;
		</t:script>
	</t:task>

        <!-- NOTE: In future version of Disco, we could alternatively use this text value as the binding of a Say step above. -->
        <agent id="_FriendWeather" text="{$friend.name} is in {$friend.data.locationName}.  Right now it's {$friend.data.weatherCondition} with a temperature of {$friend.data.temperature} degrees fahrenheit and {$friend.data.humidity} humidity."/>
	
	<!-- Level 3: Talk Special Places -->
	<!--<agent id="TalkTopCities"
		text="Forbe's Magazine named some top beautiful cities in the US.  Do you want to know what weather is like for them?">
		<user id="top_cities_bad_option" text="No, I don't want to">
			<agent text="Come on.  It is interesting to know those things!">
				<user text="all right. Go ahead">
					<do task="TopCities" />
				</user>
			</agent>
		</user>

		<user text="no thanks">
		</user>

		<user text="Sure, tell me more!">
			<do task="TopCities" />
		</user>
	</agent>

	<agent id="TopCities" text="Great, pick a location!">

		<user text="Seattle">
			<agent
				text="Beautiful City.  The temperature is {$weatherJSON.interestCities.Seattle.temperature} fahrenheit.  It is {$weatherJSON.interestCities.Seattle.weatherCondition} now.">
				<agent ref="TopCities" />
			</agent>
		</user>

		<user text="San Francisco">
			<agent
				text="ah, the Golden Gate City.  The temperature is {$weatherJSON.interestCities['San Francisco'].temperature} fahrenheit.  It is {$weatherJSON.interestCities.Miami.weatherCondition} now.">
				<agent ref="TopCities" />
			</agent>
		</user>

		<user text="Miami">
			<agent
				text="City of Beaches.  The temperature is {$weatherJSON.interestCities.Miami.temperature} fahrenheit.  It is {$weatherJSON.interestCities.Miami.weatherCondition} now.">
				<agent ref="TopCities" />
			</agent>
		</user>

		<user text="I am done.  Thanks!">
		</user>
	</agent>
	
	
	-->





	<t:task id="Ending">
		<t:subtasks id="EndingSubtask">
			<t:step name="endingtext" task="EndingText" />
		</t:subtasks>
	</t:task>

	<agent id="EndingText" text="well, weather sure is interesting.">
		<user text="yes. I love talking about weather">
			<agent text="yeh, me too." />
		</user>
		<user text="yes, I need to know the weather before I go out">
			<agent text="Feel free to ask me!" />
		</user>
		<user text="yes, but I only want to know about it sometimes">
			<agent text="I'm ready to talk about it whenever you want" />
		</user>
	</agent>


</model>

